<% if (!username) { %>
    <script>window.location.href = '/auth/login';</script>
<% } %>
<!DOCTYPE html>
<html>
<head>
    <title>Level 1 Case Record Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body { background: #f7f9fb; }
        .sidebar { min-height: 100vh; background: #fff; border-right: 1px solid #eee; }
        .sidebar .list-group-item.active { background: #e7f1ff; color: #1976d2; border: none; }
        .form-control.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        .form-control:focus.is-invalid {
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }
        .warning-box {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ffeeba;
            border-radius: 5px;
        }
        textarea.diagnosis {
            min-height: 80px;
        }
        .other-input {
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold">Hospital Management App</span>
            <div>
                <span class="me-3">Welcome, <%= username %></span>
                <a href="#" id="logout" class="btn btn-link">Sign out</a>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 sidebar pt-4">
                <div class="list-group">
                    <a href="/forms/dashboard/level1" class="list-group-item list-group-item-action">
                        <span class="me-2">&#8962;</span> Dashboard
                    </a>
                    <a href="/forms/level1" class="list-group-item list-group-item-action active">
                        <span class="me-2">+</span> New Patient Case
                    </a>
                    <a href="/forms/view/level1" class="list-group-item list-group-item-action">
                        <span class="me-2">+</span> All Patients
                    </a>
                    <a href="/forms/followup/level1" class="list-group-item list-group-item-action">
                        <span class="me-2">&#128197;</span> Subsequent Follow Up
                    </a>
                    <a href="/forms/report/level1" class="list-group-item list-group-item-action">
                        <span class="me-2">&#128202;</span> Report
                    </a>
                    <a href="/forms/appointments/book" class="list-group-item list-group-item-action">
                        <span class="me-2">&#128197;</span> Book Appointment
                    </a>
                </div>
            </nav>
            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-4 pt-4">
                <div class="container mt-4">
                    <!-- Success Modal -->
                    <% if (typeof success !== 'undefined' && success) { %>
                    <div class="modal fade show" id="successModal" tabindex="-1" style="display:block;" aria-modal="true" role="dialog">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content text-center">
                          <div class="modal-body">
                            <svg width="80" height="80" fill="green" class="mb-3" viewBox="0 0 16 16">
                              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM7 11.414l5.707-5.707-1.414-1.414L7 8.586 4.707 6.293 3.293 7.707 7 11.414z"/>
                            </svg>
                            <h4 class="mb-2">Success!</h4>
                            <p>Your form has been submitted.</p>
                            <button class="btn btn-success" onclick="window.location.href=window.location.pathname">OK</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-backdrop fade show"></div>
                    <% } %>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h4><%= editMode ? 'Edit Case Record Form' : 'Case Record Form' %></h4>
                                </div>
                                <div class="card-body">
                                    <% if (!editMode) { %>
                                    <div class="warning-box">
                                        <strong>Important:</strong> Please review all information carefully before submitting. You will have 24 hours to edit this record after submission.
                                    </div>
                                    <% } %>
                                    
                                    <form action="<%= editMode ? `/forms/level1/update/${form._id}` : '/forms/level1/submit' %>" method="POST" id="level1Form" novalidate>
                                        <!-- UID Field -->
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>UID (ADPCT No.)</label>
                                                <input type="text" class="form-control" name="uid" value="<%= uid %>" readonly required>
                                            </div>
                                            <div class="col">
                                                <label>Date</label>
                                                <input type="text" class="form-control" value="<%= new Date().toLocaleDateString() %>" readonly>
                                            </div>
                                        </div>
                                        <!-- 1. PATIENT'S DEMOGRAPHIC DETAILS -->
                                        <h5>1. Patient's Demographic Details</h5>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Name</label>
                                                <input type="text" class="form-control" name="name" required
                                                    value="<%= editMode ? form.content.name : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>Age</label>
                                                <input type="number" class="form-control" name="age" required min="0" max="120"
                                                    value="<%= editMode ? form.content.age : '' %>" oninput="this.value = Math.abs(this.value)">
                                            </div>
                                            <div class="col">
                                                <label>Gender</label>
                                                <select class="form-control" name="gender" required>
                                                    <option value="">Select Gender</option>
                                                    <option value="Male" <%= editMode && form.content.gender === 'Male' ? 'selected' : '' %>>Male</option>
                                                    <option value="Female" <%= editMode && form.content.gender === 'Female' ? 'selected' : '' %>>Female</option>
                                                    <option value="Other" <%= editMode && form.content.gender === 'Other' ? 'selected' : '' %>>Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Monthly Income (Rs.)</label>
                                                <select class="form-control" name="monthly_income" required>
                                                    <option value="">Select Income Range</option>
                                                    <option value="Less than 5000" <%= editMode && form.content.monthly_income === 'Less than 5000' ? 'selected' : '' %>>Less than 5000</option>
                                                    <option value="From 5000 to 9999" <%= editMode && form.content.monthly_income === 'From 5000 to 9999' ? 'selected' : '' %>>From 5000 to 9999</option>
                                                    <option value="From 10000 to 19999" <%= editMode && form.content.monthly_income === 'From 10000 to 19999' ? 'selected' : '' %>>From 10000 to 19999</option>
                                                    <option value="From 20000 to 49999" <%= editMode && form.content.monthly_income === 'From 20000 to 49999' ? 'selected' : '' %>>From 20000 to 49999</option>
                                                    <option value="Greater than 50000" <%= editMode && form.content.monthly_income === 'Greater than 50000' ? 'selected' : '' %>>Greater than 50000</option>
                                                </select>
                                            </div>
                                            <div class="col">
                                                <label>Family Monthly Income (Rs.)</label>
                                                <select class="form-control" name="family_monthly_income" required>
                                                    <option value="">Select Income Range</option>
                                                    <option value="Less than 5000" <%= editMode && form.content.family_monthly_income === 'Less than 5000' ? 'selected' : '' %>>Less than 5000</option>
                                                    <option value="From 5000 to 9999" <%= editMode && form.content.family_monthly_income === 'From 5000 to 9999' ? 'selected' : '' %>>From 5000 to 9999</option>
                                                    <option value="From 10000 to 19999" <%= editMode && form.content.family_monthly_income === 'From 10000 to 19999' ? 'selected' : '' %>>From 10000 to 19999</option>
                                                    <option value="From 20000 to 49999" <%= editMode && form.content.family_monthly_income === 'From 20000 to 49999' ? 'selected' : '' %>>From 20000 to 49999</option>
                                                    <option value="Greater than 50000" <%= editMode && form.content.family_monthly_income === 'Greater than 50000' ? 'selected' : '' %>>Greater than 50000</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Patient's Occupation/Job</label>
                                                <input type="text" class="form-control" name="occupation"
                                                    value="<%= editMode ? form.content.occupation : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>Education</label>
                                                <select class="form-control" name="education" required>
                                                    <option value="">Select Education</option>
                                                    <option value="illiterate" <%= editMode && form.content.education === 'illiterate' ? 'selected' : '' %>>Illiterate</option>
                                                    <option value="primary" <%= editMode && form.content.education === 'primary' ? 'selected' : '' %>>Primary (up to 5th)</option>
                                                    <option value="middle" <%= editMode && form.content.education === 'middle' ? 'selected' : '' %>>Middle (6th-8th)</option>
                                                    <option value="highschool" <%= editMode && form.content.education === 'highschool' ? 'selected' : '' %>>High School (9th-10th)</option>
                                                    <option value="intermediate" <%= editMode && form.content.education === 'intermediate' ? 'selected' : '' %>>Intermediate (11th-12th)</option>
                                                    <option value="graduate" <%= editMode && form.content.education === 'graduate' ? 'selected' : '' %>>Graduate</option>
                                                    <option value="postgraduate" <%= editMode && form.content.education === 'postgraduate' ? 'selected' : '' %>>Post Graduate</option>
                                                    <option value="professional" <%= editMode && form.content.education === 'professional' ? 'selected' : '' %>>Professional Degree</option>
                                                    <option value="other" <%= editMode && form.content.education === 'other' ? 'selected' : '' %>>Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Address Fields -->
                                        <div class="mb-3">
                                            <label>Address (Permanent)</label>
                                            <div class="row mb-2">
                                                <div class="col">
                                                    <input type="text" class="form-control" name="address_permanent_house" placeholder="House/Flat No."
                                                        value="<%= editMode ? form.content.address_permanent_house : '' %>">
                                                </div>
                                                <div class="col">
                                                    <input type="text" class="form-control" name="address_permanent_village" placeholder="Village/Locality"
                                                        value="<%= editMode ? form.content.address_permanent_village : '' %>">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <input type="text" class="form-control" name="address_permanent_city" placeholder="City/Town"
                                                        value="<%= editMode ? form.content.address_permanent_city : '' %>">
                                                </div>
                                                <div class="col">
                                                    <select class="form-control" name="address_permanent_district">
                                                        <option value="">Select District</option>
                                                        <% options.districts.forEach(function(district) { %>
                                                            <option value="<%= district %>" 
                                                                <%= editMode && form.content.address_permanent_district === district ? 'selected' : '' %>>
                                                                <%= district %>
                                                            </option>
                                                        <% }); %>
                                                    </select>
                                                </div>
                                                <div class="col">
                                                    <input type="text" class="form-control" name="address_permanent_pincode" placeholder="PIN Code" pattern="[0-9]{6}"
                                                        value="<%= editMode ? form.content.address_permanent_pincode : '' %>">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label>
                                                Address (Present)
                                                <input type="checkbox" id="same_address" style="margin-left:10px;" 
                                                    <%= editMode && form.content.same_address ? 'checked' : '' %>>
                                                <span style="font-weight:normal;">Same as Permanent</span>
                                            </label>
                                            <div id="present_address_fields">
                                                <div class="row mb-2">
                                                    <div class="col">
                                                        <input type="text" class="form-control" name="address_present_house" placeholder="House/Flat No."
                                                            value="<%= editMode ? form.content.address_present_house : '' %>">
                                                    </div>
                                                    <div class="col">
                                                        <input type="text" class="form-control" name="address_present_village" placeholder="Village/Locality"
                                                            value="<%= editMode ? form.content.address_present_village : '' %>">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col">
                                                        <input type="text" class="form-control" name="address_present_city" placeholder="City/Town"
                                                            value="<%= editMode ? form.content.address_present_city : '' %>">
                                                    </div>
                                                    <div class="col">
                                                        <select class="form-control" name="address_present_district">
                                                            <option value="">Select District</option>
                                                            <% options.districts.forEach(function(district) { %>
                                                                <option value="<%= district %>" 
                                                                    <%= editMode && form.content.address_present_district === district ? 'selected' : '' %>>
                                                                    <%= district %>
                                                                </option>
                                                            <% }); %>
                                                        </select>
                                                    </div>
                                                    <div class="col">
                                                        <input type="text" class="form-control" name="address_present_pincode" placeholder="PIN Code" pattern="[0-9]{6}"
                                                            value="<%= editMode ? form.content.address_present_pincode : '' %>">
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" name="same_address" id="same_address_value" 
                                                value="<%= editMode ? (form.content.same_address ? 'yes' : 'no') : 'no' %>">
                                        </div>
                                        
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Contact Phone No.</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">+91</span>
                                                    <input type="tel" class="form-control" name="contact_phone" required pattern="^\d{10}$" maxlength="10" placeholder="10 digits"
                                                        value="<%= editMode ? (form.content.contact_phone ? form.content.contact_phone.replace('+91', '') : '') : '' %>"
                                                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,10)">
                                                </div>
                                            </div>
                                            <div class="col">
                                                <label>Care giver's phone</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">+91</span>
                                                    <input type="tel" class="form-control" name="caregiver_phone" pattern="^\d{10}$" maxlength="10" placeholder="10 digits"
                                                        value="<%= editMode ? (form.content.caregiver_phone ? form.content.caregiver_phone.replace('+91', '') : '') : '' %>"
                                                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,10)">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Accompanying Caregiver</label>
                                                <input type="text" class="form-control" name="caregiver"
                                                    value="<%= editMode ? form.content.caregiver : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>Other Significant Detail</label>
                                                <input type="text" class="form-control" name="other_significant_detail"
                                                    value="<%= editMode ? form.content.other_significant_detail : '' %>">
                                            </div>
                                        </div>

                                        <!-- 2. MEDICAL HISTORY -->
                                        <h5 class="mt-4">2. Medical History</h5>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Diagnosis</label>
                                                <textarea class="form-control diagnosis" name="diagnosis" rows="3"><%= editMode ? form.content.diagnosis : '' %></textarea>
                                            </div>
                                            <div class="col">
                                                <label>Body Location</label>
                                                <select class="form-control" name="body_location" required>
                                                    <option value="">Select Body Location</option>
                                                    <% options.bodyLocations.forEach(function(location) { %>
                                                        <option value="<%= location %>" 
                                                            <%= editMode && form.content.body_location === location ? 'selected' : '' %>>
                                                            <%= location %>
                                                        </option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Stage (T)</label>
                                                <input type="text" class="form-control" name="stage_t"
                                                    value="<%= editMode ? form.content.stage_t : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>Stage (N)</label>
                                                <input type="text" class="form-control" name="stage_n"
                                                    value="<%= editMode ? form.content.stage_n : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>Stage (M)</label>
                                                <input type="text" class="form-control" name="stage_m"
                                                    value="<%= editMode ? form.content.stage_m : '' %>">
                                            </div>
                                        </div>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Clinical/Pathologic Stage</label>
                                                <input type="text" class="form-control" name="clinical_stage"
                                                    value="<%= editMode ? form.content.clinical_stage : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>Date of 1st Diagnosis</label>
                                                <input type="date" class="form-control" name="first_diagnosis_date" max="<%= new Date().toISOString().split('T')[0] %>"
                                                    value="<%= editMode ? form.content.first_diagnosis_date : '' %>">
                                            </div>
                                        </div>
                                        <div class="mb-2 row">
                                            <div class="col">
                                                <label>Referred From (Hospital, Doctor)</label>
                                                <input type="text" class="form-control" name="referred_from" id="referred_from"
                                                    value="<%= editMode ? form.content.referred_from : '' %>">
                                            </div>
                                            <div class="col">
                                                <label>If Self Referred</label>
                                                <select class="form-control" name="self_referred" id="self_referred">
                                                    <option value="unknown" <%= editMode && form.content.self_referred === 'unknown' ? 'selected' : '' %>>Unknown</option>
                                                    <option value="yes" <%= editMode && form.content.self_referred === 'yes' ? 'selected' : '' %>>Yes</option>
                                                    <option value="no" <%= editMode && form.content.self_referred === 'no' ? 'selected' : '' %>>No</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- 3. TREATMENT HISTORY (BEFORE COMING TO ADPCT) -->
                                        <h5 class="mt-4">3. Treatment History (Before Coming to ADPCT)</h5>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Treatment</th>
                                                    <th>Yes/No</th>
                                                    <th>If Yes (Curative/Palliative/Not Explained)</th>
                                                    <th>Date (Started)</th>
                                                    <th>Date (Completed)</th>
                                                    <th>Remark by Patient/Family</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% ['Surgery','Radiotherapy','Chemotherapy','Hormone Drug','Immunotherapy/Targeted Drug','Alternate (Homeo/Ayurveda/Other)','Palliative Care'].forEach(function(treatment, idx) { %>
                                                <tr>
                                                    <td><%= treatment %></td>
                                                    <td>
                                                        <select class="form-control treatment-yesno" data-idx="<%= idx %>" name="treatment[<%= idx %>][yesno]">
                                                            <option value="unknown" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].yesno === 'unknown' ? 'selected' : '' %>>Unknown</option>
                                                            <option value="yes" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].yesno === 'yes' ? 'selected' : '' %>>Yes</option>
                                                            <option value="no" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].yesno === 'no' ? 'selected' : '' %>>No</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select class="form-control treatment-type" id="treatment-type-<%= idx %>" name="treatment[<%= idx %>][type]">
                                                            <option value="unknown" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].type === 'unknown' ? 'selected' : '' %>>Unknown</option>
                                                            <option value="curative" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].type === 'curative' ? 'selected' : '' %>>Curative</option>
                                                            <option value="palliative" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].type === 'palliative' ? 'selected' : '' %>>Palliative</option>
                                                            <option value="not_explained" <%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].type === 'not_explained' ? 'selected' : '' %>>Not Explained</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="date" class="form-control treatment-date" id="treatment-start-<%= idx %>" name="treatment[<%= idx %>][start]" max="<%= new Date().toISOString().split('T')[0] %>"
                                                            value="<%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].start ? form.content.treatment[idx].start : '' %>">
                                                    </td>
                                                    <td>
                                                        <input type="date" class="form-control treatment-date" id="treatment-end-<%= idx %>" name="treatment[<%= idx %>][end]" max="<%= new Date().toISOString().split('T')[0] %>"
                                                            value="<%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].end ? form.content.treatment[idx].end : '' %>">
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control treatment-remark" id="treatment-remark-<%= idx %>" name="treatment[<%= idx %>][remark]"
                                                            value="<%= editMode && form.content.treatment && form.content.treatment[idx] && form.content.treatment[idx].remark ? form.content.treatment[idx].remark : '' %>">
                                                    </td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>

                                        <!-- 4. ASSOCIATED AILMENTS (CO-MORBIDITY) -->
                                        <h5 class="mt-4">4. Associated Ailments (Co-morbidity)</h5>
                                        <select class="form-control mb-2" name="comorbidity_type" id="comorbidity_type">
                                            <% options.comorbidities.forEach(function(comorbidity) { %>
                                                <option value="<%= comorbidity %>" 
                                                    <%= editMode && form.content.comorbidity_type === comorbidity ? 'selected' : '' %>>
                                                    <%= comorbidity %>
                                                </option>
                                            <% }); %>
                                        </select>
                                        <div id="other_comorbidity" class="other-input">
                                            <input type="text" class="form-control" name="comorbidity_other" placeholder="Please specify other comorbidity"
                                                value="<%= editMode && form.content.comorbidity_other ? form.content.comorbidity_other : '' %>">
                                        </div>

                                        <!-- 5. PAIN ASSESSMENT SCALE -->
                                        <h5 class="mt-4">5. Pain Assessment Scale</h5>
                                        <div class="mb-2">
                                            <label>Pain Intensity (0-10)</label>
                                            <select class="form-control" name="pain_intensity">
                                                <option value="">Select Pain Intensity</option>
                                                <% for(let i=0; i<=10; i++) { %>
                                                    <option value="<%= i %>" <%= editMode && form.content.pain_intensity == i ? 'selected' : '' %>><%= i %></option>
                                                <% } %>
                                            </select>
                                        </div>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Pain Location</th>
                                                    <th>Intensity</th>
                                                    <th>Palliative Factors</th>
                                                    <th>Proactive Factors</th>
                                                    <th>Quality of Pain</th>
                                                    <th>Temporal Factors</th>
                                                    <th>Radiation</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% for(let i=0;i<2;i++){ %>
                                                <tr>
                                                    <td>
                                                        <select class="form-control" name="pain[<%= i %>][location]">
                                                            <option value="">Select Location</option>
                                                            <% options.painLocations.forEach(function(location) { %>
                                                                <option value="<%= location %>" 
                                                                    <%= editMode && form.content.pain && form.content.pain[i] && form.content.pain[i].location === location ? 'selected' : '' %>>
                                                                    <%= location %>
                                                                </option>
                                                            <% }); %>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select class="form-control" name="pain[<%= i %>][intensity]">
                                                            <option value="">Select</option>
                                                            <% for(let j=0; j<=10; j++) { %>
                                                                <option value="<%= j %>" 
                                                                    <%= editMode && form.content.pain && form.content.pain[i] && form.content.pain[i].intensity == j ? 'selected' : '' %>>
                                                                    <%= j %>
                                                                </option>
                                                            <% } %>
                                                        </select>
                                                    </td>
                                                    <td><input type="text" class="form-control" name="pain[<%= i %>][palliative]"
                                                        value="<%= editMode && form.content.pain && form.content.pain[i] ? form.content.pain[i].palliative : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="pain[<%= i %>][proactive]"
                                                        value="<%= editMode && form.content.pain && form.content.pain[i] ? form.content.pain[i].proactive : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="pain[<%= i %>][quality]"
                                                        value="<%= editMode && form.content.pain && form.content.pain[i] ? form.content.pain[i].quality : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="pain[<%= i %>][temporal]"
                                                        value="<%= editMode && form.content.pain && form.content.pain[i] ? form.content.pain[i].temporal : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="pain[<%= i %>][radiation]"
                                                        value="<%= editMode && form.content.pain && form.content.pain[i] ? form.content.pain[i].radiation : '' %>"></td>
                                                </tr>
                                                <% } %>
                                            </tbody>
                                        </table>

                                        <!-- 6. PSYCHOSOCIAL ASSESSMENT -->
                                        <h5 class="mt-4">6. Psychosocial Assessment</h5>
                                        <div class="mb-2">
                                            <label>Patient's Insight: Information about diagnosis</label>
                                            <select class="form-control" name="insight_diagnosis">
                                                <option value="yes" <%= editMode && form.content.insight_diagnosis === 'yes' ? 'selected' : '' %>>Yes</option>
                                                <option value="no" <%= editMode && form.content.insight_diagnosis === 'no' ? 'selected' : '' %>>No</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Information about Disease Status</label>
                                            <select class="form-control" name="disease_status">
                                                <option value="adequate" <%= editMode && form.content.disease_status === 'adequate' ? 'selected' : '' %>>Adequate</option>
                                                <option value="partial" <%= editMode && form.content.disease_status === 'partial' ? 'selected' : '' %>>Partial</option>
                                                <option value="nil" <%= editMode && form.content.disease_status === 'nil' ? 'selected' : '' %>>Nil</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Disease Status told by (outside)</label>
                                            <input type="text" class="form-control" name="disease_status_told_by" placeholder="Doctor/Nurse/Family/Friends/Guessed"
                                                value="<%= editMode ? form.content.disease_status_told_by : '' %>">
                                        </div>
                                        <div class="mb-2">
                                            <label>Patient is Breadwinner</label>
                                            <select class="form-control" name="breadwinner">
                                                <option value="yes" <%= editMode && form.content.breadwinner === 'yes' ? 'selected' : '' %>>Yes</option>
                                                <option value="no" <%= editMode && form.content.breadwinner === 'no' ? 'selected' : '' %>>No</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Type of Family</label>
                                            <select class="form-control" name="family_type">
                                                <option value="nuclear" <%= editMode && form.content.family_type === 'nuclear' ? 'selected' : '' %>>Nuclear</option>
                                                <option value="joint" <%= editMode && form.content.family_type === 'joint' ? 'selected' : '' %>>Joint</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>No. of Dependent Family Members</label>
                                            <select class="form-control" name="dependent_family_members">
                                                <option value="">Select Number</option>
                                                <% for(let i=0; i<=10; i++) { %>
                                                    <option value="<%= i %>" <%= editMode && form.content.dependent_family_members == i ? 'selected' : '' %>><%= i %></option>
                                                <% } %>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Spouse's Attitude</label>
                                            <select class="form-control" name="spouse_attitude">
                                                <option value="not_applicable" <%= editMode && form.content.spouse_attitude === 'not_applicable' ? 'selected' : '' %>>Not Applicable</option>
                                                <option value="sympathetic" <%= editMode && form.content.spouse_attitude === 'sympathetic' ? 'selected' : '' %>>Sympathetic</option>
                                                <option value="considerate" <%= editMode && form.content.spouse_attitude === 'considerate' ? 'selected' : '' %>>Considerate</option>
                                                <option value="indifferent" <%= editMode && form.content.spouse_attitude === 'indifferent' ? 'selected' : '' %>>Indifferent</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Children Attitude</label>
                                            <select class="form-control" name="children_attitude">
                                                <option value="not_applicable" <%= editMode && form.content.children_attitude === 'not_applicable' ? 'selected' : '' %>>Not Applicable</option>
                                                <option value="sympathetic" <%= editMode && form.content.children_attitude === 'sympathetic' ? 'selected' : '' %>>Sympathetic</option>
                                                <option value="considerate" <%= editMode && form.content.children_attitude === 'considerate' ? 'selected' : '' %>>Considerate</option>
                                                <option value="indifferent" <%= editMode && form.content.children_attitude === 'indifferent' ? 'selected' : '' %>>Indifferent</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Accompanying Caregiver is Breadwinner</label>
                                            <select class="form-control" name="caregiver_breadwinner">
                                                <option value="yes" <%= editMode && form.content.caregiver_breadwinner === 'yes' ? 'selected' : '' %>>Yes</option>
                                                <option value="no" <%= editMode && form.content.caregiver_breadwinner === 'no' ? 'selected' : '' %>>No</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Reaction to Illness</label>
                                            <select class="form-control" name="reaction_illness">
                                                <option value="anger" <%= editMode && form.content.reaction_illness === 'anger' ? 'selected' : '' %>>Anger</option>
                                                <option value="depression" <%= editMode && form.content.reaction_illness === 'depression' ? 'selected' : '' %>>Depression</option>
                                                <option value="denial" <%= editMode && form.content.reaction_illness === 'denial' ? 'selected' : '' %>>Denial</option>
                                                <option value="acceptance" <%= editMode && form.content.reaction_illness === 'acceptance' ? 'selected' : '' %>>Acceptance</option>
                                                <option value="cannot_say" <%= editMode && form.content.reaction_illness === 'cannot_say' ? 'selected' : '' %>>Cannot Say</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Patient is Engaging in Family Activities</label>
                                            <select class="form-control" name="family_activities">
                                                <option value="same" <%= editMode && form.content.family_activities === 'same' ? 'selected' : '' %>>Same as Before</option>
                                                <option value="decreased" <%= editMode && form.content.family_activities === 'decreased' ? 'selected' : '' %>>Decreased</option>
                                                <option value="isolated" <%= editMode && form.content.family_activities === 'isolated' ? 'selected' : '' %>>Completely Isolated</option>
                                                <option value="unable" <%= editMode && form.content.family_activities === 'unable' ? 'selected' : '' %>>Unable</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Social Stigma (if any)</label>
                                            <input type="text" class="form-control" name="social_stigma"
                                                value="<%= editMode ? form.content.social_stigma : '' %>">
                                        </div>

                                        <!-- 7. SPIRITUAL ASSESSMENT -->
                                        <h5 class="mt-4">7. Spiritual Assessment</h5>
                                        <div class="mb-2">
                                            <label>Belief in God</label>
                                            <select class="form-control" name="belief_god">
                                                <option value="yes" <%= editMode && form.content.belief_god === 'yes' ? 'selected' : '' %>>Yes</option>
                                                <option value="no" <%= editMode && form.content.belief_god === 'no' ? 'selected' : '' %>>No</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Present Belief</label>
                                            <select class="form-control" name="present_belief">
                                                <option value="same" <%= editMode && form.content.present_belief === 'same' ? 'selected' : '' %>>Same</option>
                                                <option value="increased" <%= editMode && form.content.present_belief === 'increased' ? 'selected' : '' %>>Increased</option>
                                                <option value="decreased" <%= editMode && form.content.present_belief === 'decreased' ? 'selected' : '' %>>Decreased</option>
                                                <option value="no_belief" <%= editMode && form.content.present_belief === 'no_belief' ? 'selected' : '' %>>No Belief</option>
                                            </select>
                                        </div>

                                        <!-- 8. CURRENT MEDICATION -->
                                        <h5 class="mt-4">8. Current Medication (at 1st Visit to ADPCT)</h5>
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Drug</th>
                                                    <th>Dose</th>
                                                    <th>Response</th>
                                                    <th>Started From (Details)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% for(let i=0;i<7;i++){ %>
                                                <tr>
                                                    <td><input type="text" class="form-control" name="medication[<%= i %>][drug]"
                                                        value="<%= editMode && form.content.medication && form.content.medication[i] ? form.content.medication[i].drug : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="medication[<%= i %>][dose]"
                                                        value="<%= editMode && form.content.medication && form.content.medication[i] ? form.content.medication[i].dose : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="medication[<%= i %>][response]"
                                                        value="<%= editMode && form.content.medication && form.content.medication[i] ? form.content.medication[i].response : '' %>"></td>
                                                    <td><input type="text" class="form-control" name="medication[<%= i %>][started_from]"
                                                        value="<%= editMode && form.content.medication && form.content.medication[i] ? form.content.medication[i].started_from : '' %>"></td>
                                                </tr>
                                                <% } %>
                                            </tbody>
                                        </table>
                                        <div class="mb-2">
                                            <label>Receiving any Cancer Treatment?</label>
                                            <input type="text" class="form-control" name="receiving_cancer_treatment"
                                                value="<%= editMode ? form.content.receiving_cancer_treatment : '' %>">
                                        </div>

                                        <!-- 9. CLINICAL RECORD -->
                                        <h5 class="mt-4">9. Clinical Record</h5>
                                        <div class="mb-2">
                                            <label>General Condition</label>
                                            <input type="text" class="form-control" name="general_condition"
                                                value="<%= editMode ? form.content.general_condition : '' %>">
                                        </div>
                                        <div class="mb-2">
                                            <label>Personal Hygiene</label>
                                            <input type="text" class="form-control" name="personal_hygiene"
                                                value="<%= editMode ? form.content.personal_hygiene : '' %>">
                                        </div>
                                        <div class="mb-2">
                                            <label>Oral Condition</label>
                                            <select class="form-control" name="oral_condition">
                                                <option value="">Select Oral Condition</option>
                                                <% options.oralConditions.forEach(function(condition) { %>
                                                    <option value="<%= condition %>" 
                                                        <%= editMode && form.content.oral_condition === condition ? 'selected' : '' %>>
                                                        <%= condition %>
                                                    </option>
                                                <% }); %>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label>Body Build</label>
                                            <input type="text" class="form-control" name="body_build"
                                                value="<%= editMode ? form.content.body_build : '' %>">
                                        </div>
                                        <div class="mb-2">
                                            <label>Hydration</label>
                                            <input type="text" class="form-control" name="hydration"
                                                value="<%= editMode ? form.content.hydration : '' %>">
                                        </div>
                                        <div class="mb-2">
                                            <label>Feeding</label>
                                            <input type="text" class="form-control" name="feeding"
                                                value="<%= editMode ? form.content.feeding : '' %>">
                                        </div>
                                        <div class="mb-2">
                                            <label>Bowel Movement</label>
                                            <input type="text" class="form-control" name="bowel_movement"
                                                value="<%= editMode ? form.content.bowel_movement : '' %>">
                                        </div>

                                        <!-- 10. ECOG PERFORMANCE STATUS SCORE -->
                                        <h5 class="mt-4">10. ECOG Performance Status Score</h5>
                                        <select class="form-control mb-2" name="ecog_score">
                                            <option value="0" <%= editMode && form.content.ecog_score === '0' ? 'selected' : '' %>>0 - Normal Activity</option>
                                            <option value="1" <%= editMode && form.content.ecog_score === '1' ? 'selected' : '' %>>1 - Light Household Work</option>
                                            <option value="2" <%= editMode && form.content.ecog_score === '2' ? 'selected' : '' %>>2 - Ambulatory and Capable of Self-care</option>
                                            <option value="3" <%= editMode && form.content.ecog_score === '3' ? 'selected' : '' %>>3 - Only Limited Self-care, Confined to Bed more than 50% of waking hours</option>
                                            <option value="4" <%= editMode && form.content.ecog_score === '4' ? 'selected' : '' %>>4 - Completely Disabled, Totally Confined to bed or Chair</option>
                                        </select>

                                        <!-- 11. SYMPTOMS AS ON DATE -->
                                        <h5 class="mt-4">11. Symptoms as on Date (To Record)</h5>
                                        <textarea class="form-control mb-3" name="symptoms" rows="2" placeholder="List symptoms (comma separated)"><%= editMode ? form.content.symptoms : '' %></textarea>

                                        <button type="submit" class="btn btn-primary mt-3">Submit</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Logout functionality
        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            fetch('/auth/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin'
            }).then(response => {
                if (response.ok) {
                    localStorage.setItem('logout-event', Date.now()); // Trigger logout event
                    window.location.href = '/auth/login';
                }
            }).catch(err => console.error('Logout failed:', err));
        });

        // Listen for logout event across tabs
        window.addEventListener('storage', function(event) {
            if (event.key === 'logout-event') {
                window.location.href = '/auth/login'; // Redirect to login page
            }
        });

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('level1Form');
            
            form.addEventListener('submit', function(event) {
                let isValid = true;
                const requiredFields = form.querySelectorAll('[required]');
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                // Validate phone number
                const phoneField = form.querySelector('[name="contact_phone"]');
                if (phoneField && !phoneField.value.match(/^\d{10}$/)) {
                    phoneField.classList.add('is-invalid');
                    isValid = false;
                }
                
                if (!isValid) {
                    event.preventDefault();
                    alert('Please fill all required fields correctly. Required fields are marked in red.');
                }
            });
            
            // Clear validation on input
            form.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
            });
            
            // Present Address - Same as Permanent logic
            const sameCheckbox = document.getElementById('same_address');
            const sameAddressValue = document.getElementById('same_address_value');
            const presentAddressFields = document.getElementById('present_address_fields');
            
            function syncAddress() {
                if (sameCheckbox.checked) {
                    presentAddressFields.style.display = 'none';
                    sameAddressValue.value = 'yes';
                } else {
                    presentAddressFields.style.display = 'block';
                    sameAddressValue.value = 'no';
                }
            }
            
            sameCheckbox.addEventListener('change', syncAddress);
            syncAddress(); // Initialize on page load
            
            // Referred From / Self Referred logic
            const referredFromField = document.getElementById('referred_from');
            const selfReferredField = document.getElementById('self_referred');
            
            referredFromField.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    selfReferredField.value = 'no';
                }
            });
            
            // Comorbidity Other field toggle
            const comorbidityType = document.getElementById('comorbidity_type');
            const otherComorbidity = document.getElementById('other_comorbidity');
            
            function toggleOtherComorbidity() {
                if (comorbidityType.value === 'Other') {
                    otherComorbidity.style.display = 'block';
                } else {
                    otherComorbidity.style.display = 'none';
                }
            }
            
            comorbidityType.addEventListener('change', toggleOtherComorbidity);
            toggleOtherComorbidity(); // Initialize on page load
        });

        // Prevent showing stale form on browser back/forward navigation
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                // If URL contains ?success=1, redirect to dashboard instead of reloading form
                if (window.location.search.includes('success=1')) {
                    window.location.href = '/forms/dashboard/level1';
                } else {
                    window.location.reload();
                }
            }
        });

        // Remove ?success=1 from URL after showing modal (so it doesn't show again)
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.search.includes('success=1')) {
                if (window.history.replaceState) {
                    const url = window.location.pathname + window.location.search.replace(/([?&])success=1(&)?/, function(match, p1, p2) {
                        if (p1 === '?' && !p2) return '';
                        if (p1 === '?' && p2) return '?';
                        if (p1 === '&') return p2 ? '&' : '';
                        return '';
                    }).replace(/[?&]$/, '');
                    window.history.replaceState({}, document.title, url);
                }
            }
        });
    </script>
</body>
</html>
